# requests.py
"""
–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞–º–∏, –∑–∞—è–≤–∫–∞–º–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
"""
import json
import os
import re
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple, Any
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ContextTypes
import logging
from telegram.error import BadRequest

from need_help import request_system

logger = logging.getLogger(__name__)

# –î–µ–ª–∞–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ need_help, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É.
try:
    from need_help import handle_request_callback as _handle_request_callback
    from need_help import search_requests as _search_requests
except Exception as e:
    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ need_help: {e}")
    _handle_request_callback = None
    _search_requests = None

class RequestManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ —Ç–∏–ø–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def __init__(self):
        self.messages_file = "data/request_messages.json"
        self.reviews_file = "data/request_reviews.json"
        self.notifications_file = "data/request_notifications.json"
        self._init_data_files()
    
    def _init_data_files(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö"""
        os.makedirs("data", exist_ok=True)
        
        for file_path in [self.messages_file, self.reviews_file, self.notifications_file]:
            if not os.path.exists(file_path):
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump([], f, ensure_ascii=False)
    
    def save_message(self, request_id: int, sender_id: int, sender_name: str, 
                    receiver_id: int, message: str, message_type: str = "text") -> int:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É"""
        with open(self.messages_file, 'r', encoding='utf-8') as f:
            messages = json.load(f)
        
        msg = {
            'id': len(messages) + 1,
            'request_id': request_id,
            'sender_id': sender_id,
            'sender_name': sender_name,
            'receiver_id': receiver_id,
            'message': message,
            'message_type': message_type,
            'timestamp': datetime.now().isoformat(),
            'is_read': False
        }
        
        messages.append(msg)
        
        with open(self.messages_file, 'w', encoding='utf-8') as f:
            json.dump(messages, f, ensure_ascii=False, indent=2)
        
        # –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        self.create_notification(
            user_id=receiver_id,
            title="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            message=f"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É #{request_id}",
            notification_type="message",
            data={'request_id': request_id, 'message_id': msg['id']}
        )
        
        return msg['id']
    
    def create_notification(self, user_id: int, title: str, message: str, 
                           notification_type: str, data: Dict = None):
        """–°–æ–∑–¥–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with open(self.notifications_file, 'r', encoding='utf-8') as f:
            notifications = json.load(f)
        
        notification = {
            'id': len(notifications) + 1,
            'user_id': user_id,
            'title': title,
            'message': message,
            'type': notification_type,
            'data': data or {},
            'timestamp': datetime.now().isoformat(),
            'is_read': False
        }
        
        notifications.append(notification)
        
        with open(self.notifications_file, 'w', encoding='utf-8') as f:
            json.dump(notifications, f, ensure_ascii=False, indent=2)
    
    def get_unread_notifications(self, user_id: int) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with open(self.notifications_file, 'r', encoding='utf-8') as f:
            notifications = json.load(f)
        
        unread = [
            n for n in notifications 
            if n['user_id'] == user_id and not n['is_read']
        ]
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
        unread.sort(key=lambda x: x['timestamp'], reverse=True)
        
        return unread
    
    def mark_notification_read(self, notification_id: int):
        """–û—Ç–º–µ—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"""
        with open(self.notifications_file, 'r', encoding='utf-8') as f:
            notifications = json.load(f)
        
        for notification in notifications:
            if notification['id'] == notification_id:
                notification['is_read'] = True
                break
        
        with open(self.notifications_file, 'w', encoding='utf-8') as f:
            json.dump(notifications, f, ensure_ascii=False, indent=2)
    
    def save_review(self, request_id: int, reviewer_id: int, reviewed_id: int,
                   rating: int, comment: str, review_type: str = "request") -> int:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–∑—ã–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É"""
        if rating < 1 or rating > 5:
            raise ValueError("–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5")
        
        with open(self.reviews_file, 'r', encoding='utf-8') as f:
            reviews = json.load(f)
        
        review = {
            'id': len(reviews) + 1,
            'request_id': request_id,
            'reviewer_id': reviewer_id,
            'reviewed_id': reviewed_id,
            'rating': rating,
            'comment': comment,
            'type': review_type,
            'timestamp': datetime.now().isoformat(),
            'is_verified': False
        }
        
        reviews.append(review)
        
        with open(self.reviews_file, 'w', encoding='utf-8') as f:
            json.dump(reviews, f, ensure_ascii=False, indent=2)
        
        return review['id']
    
    def get_user_reviews(self, user_id: int) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with open(self.reviews_file, 'r', encoding='utf-8') as f:
            reviews = json.load(f)
        
        user_reviews = [r for r in reviews if r['reviewed_id'] == user_id]
        
        if not user_reviews:
            return {
                'count': 0,
                'average_rating': 0,
                'reviews': []
            }
        
        avg_rating = sum(r['rating'] for r in user_reviews) / len(user_reviews)
        
        return {
            'count': len(user_reviews),
            'average_rating': round(avg_rating, 1),
            'reviews': user_reviews[-10:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ—Ç–∑—ã–≤–æ–≤
        }
    
    def get_request_messages(self, request_id: int) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É"""
        with open(self.messages_file, 'r', encoding='utf-8') as f:
            messages = json.load(f)
        
        request_messages = [
            msg for msg in messages 
            if msg['request_id'] == request_id
        ]
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        request_messages.sort(key=lambda x: x['timestamp'])
        
        return request_messages

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞
request_manager = RequestManager()

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è ConversationHandler
SEND_MESSAGE, SEND_REVIEW, SELECT_RATING = range(20, 23)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_requests_main_keyboard():
    """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    keyboard = [
        [KeyboardButton("üì® –ú–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"), KeyboardButton("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")],
        [KeyboardButton("‚≠ê –ú–æ–∏ –æ—Ç–∑—ã–≤—ã"), KeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")],
        [KeyboardButton("üí¨ –ß–∞—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É"), KeyboardButton("üìã –ê–∫—Ç–∏–≤–Ω—ã–µ")],
        [KeyboardButton("üîç –ü–æ–∏—Å–∫ –ø–æ ID"), KeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        [KeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)

def get_messages_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π"""
    keyboard = [
        [KeyboardButton("‚úâÔ∏è –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"), KeyboardButton("üì• –í—Ö–æ–¥—è—â–∏–µ")],
        [KeyboardButton("üì§ –ò—Å—Ö–æ–¥—è—â–∏–µ"), KeyboardButton("üí¨ –î–∏–∞–ª–æ–≥–∏")],
        [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)

def get_review_rating_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞"""
    keyboard = [
        [
            InlineKeyboardButton("‚≠ê", callback_data="rate_1"),
            InlineKeyboardButton("‚≠ê‚≠ê", callback_data="rate_2"),
            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê", callback_data="rate_3"),
            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê‚≠ê", callback_data="rate_4"),
            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê", callback_data="rate_5")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_request_chat_keyboard(request_id: int):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —á–∞—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É"""
    keyboard = [
        [
            InlineKeyboardButton("üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", callback_data=f"chat_send_{request_id}"),
            InlineKeyboardButton("üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª", callback_data=f"chat_attach_{request_id}")
        ],
        [
            InlineKeyboardButton("‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data=f"chat_review_{request_id}"),
            InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç", callback_data=f"chat_end_{request_id}")
        ],
        [
            InlineKeyboardButton("üîô –ö –∑–∞–ø—Ä–æ—Å—É", callback_data=f"chat_back_{request_id}")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
async def show_requests_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞–º–∏"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notifications = request_manager.get_unread_notifications(user_id)
    notification_count = len(notifications)
    
    greeting = f"üìã *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏*\n\n"
    
    if notification_count > 0:
        greeting += f"üîî –£ –≤–∞—Å {notification_count} –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n"
    
    greeting += (
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n"
        "‚Ä¢ –û—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã\n"
        "‚Ä¢ –û–±—â–∞—Ç—å—Å—è –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )
    
    await update.message.reply_text(
        greeting,
        reply_markup=get_requests_main_keyboard(),
        parse_mode='Markdown'
    )

async def show_notifications(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    notifications = request_manager.get_unread_notifications(user_id)
    
    if not notifications:
        await update.message.reply_text(
            "üì≠ *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è*\n\n"
            "–£ –≤–∞—Å –Ω–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.",
            parse_mode='Markdown',
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    await update.message.reply_text(
        f"üîî *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ({len(notifications)})*\n\n"
        "üëá –í–∞—à–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:",
        parse_mode='Markdown'
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    for i, notification in enumerate(notifications[:5], 1):
        time_ago = get_time_ago(notification['timestamp'])
        
        notification_text = (
            f"üìå *{notification['title']}*\n"
            f"{notification['message']}\n"
            f"üïê {time_ago}\n"
        )
        
        keyboard = [[
            InlineKeyboardButton(
                "‚úÖ –ü—Ä–æ—á–∏—Ç–∞—Ç—å", 
                callback_data=f"read_notif_{notification['id']}"
            ),
            InlineKeyboardButton(
                "üìã –ö –∑–∞–ø—Ä–æ—Å—É" if 'request_id' in notification.get('data', {}) else "üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ",
                callback_data=f"view_notif_{notification['id']}"
            )
        ]]
        
        await update.message.reply_text(
            notification_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    if len(notifications) > 5:
        await update.message.reply_text(
            f"–ò –µ—â–µ {len(notifications) - 5} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...",
            reply_markup=get_requests_main_keyboard()
        )

def get_time_ago(timestamp_str: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É '—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–∑–∞–¥'"""
    timestamp = datetime.fromisoformat(timestamp_str)
    now = datetime.now()
    diff = now - timestamp
    
    if diff.days > 0:
        return f"{diff.days} –¥–Ω. –Ω–∞–∑–∞–¥"
    elif diff.seconds // 3600 > 0:
        return f"{diff.seconds // 3600} —á. –Ω–∞–∑–∞–¥"
    elif diff.seconds // 60 > 0:
        return f"{diff.seconds // 60} –º–∏–Ω. –Ω–∞–∑–∞–¥"
    else:
        return "—Ç–æ–ª—å–∫–æ —á—Ç–æ"

async def show_messages_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await update.message.reply_text(
        "üì® *–°–æ–æ–±—â–µ–Ω–∏—è*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        reply_markup=get_messages_keyboard(),
        parse_mode='Markdown'
    )

async def start_new_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    await update.message.reply_text(
        "‚úâÔ∏è *–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å:\n\n"
        "–§–æ—Ä–º–∞—Ç:\n"
        "‚Ä¢ –î–ª—è –∑–∞–ø—Ä–æ—Å–∞: `#123` –∏–ª–∏ `123`\n"
        "‚Ä¢ –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `@username` –∏–ª–∏ `user123`\n\n"
        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ 'üîô –ù–∞–∑–∞–¥' –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
    )
    return SEND_MESSAGE

async def process_message_target(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è"""
    if update.message.text == "üîô –ù–∞–∑–∞–¥":
        await update.message.reply_text(
            "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            reply_markup=get_requests_main_keyboard()
        )
        from telegram.ext import ConversationHandler
        return ConversationHandler.END
    
    target = update.message.text.strip()
    
    # –ü–∞—Ä—Å–∏–º —Ü–µ–ª—å
    if target.startswith('#') or target.isdigit():
        # –≠—Ç–æ ID –∑–∞–ø—Ä–æ—Å–∞
        request_id = int(target.replace('#', ''))
        context.user_data['message_target'] = {'type': 'request', 'id': request_id}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        request = need_help_system.get_request_by_id(request_id)
        if not request:
            await update.message.reply_text(
                f"‚ùå –ó–∞–ø—Ä–æ—Å #{request_id} –Ω–µ –Ω–∞–π–¥–µ–Ω.\n"
                f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ID –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
                reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
            )
            return SEND_MESSAGE
        
        await update.message.reply_text(
            f"üìã *–ó–∞–ø—Ä–æ—Å #{request_id}*\n"
            f"üìù {request.get('category', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è')}\n"
            f"üë§ –ê–≤—Ç–æ—Ä: {request.get('username', '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')}\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
            parse_mode='Markdown',
            reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
    
    elif target.startswith('@') or re.match(r'^[a-zA-Z0-9_]+$', target):
        # –≠—Ç–æ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        username = target.replace('@', '')
        context.user_data['message_target'] = {'type': 'user', 'username': username}
        
        await update.message.reply_text(
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {target}\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
            parse_mode='Markdown',
            reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
    
    else:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
            "‚Ä¢ –î–ª—è –∑–∞–ø—Ä–æ—Å–∞: `#123`\n"
            "‚Ä¢ –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `@username`\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
            parse_mode='Markdown',
            reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
        return SEND_MESSAGE
    
    return SEND_MESSAGE + 1  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

async def send_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    message_text = update.message.text
    
    if message_text == "üîô –ù–∞–∑–∞–¥":
        await update.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
            reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
        return SEND_MESSAGE
    
    target = context.user_data.get('message_target', {})
    user = update.effective_user
    
    if target.get('type') == 'request':
        request_id = target['id']
        
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞: –ø–æ–ª—É—á–∞—Ç–µ–ª—å - –∞–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
        request = need_help_system.get_request_by_id(request_id)
        if request:
            receiver_id = request['user_id']
            receiver_name = request['username']
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            message_id = request_manager.save_message(
                request_id=request_id,
                sender_id=user.id,
                sender_name=user.username or user.first_name,
                receiver_id=receiver_id,
                message=message_text
            )
            
            await update.message.reply_text(
                f"‚úÖ *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!*\n\n"
                f"üìã –ö –∑–∞–ø—Ä–æ—Å—É: #{request_id}\n"
                f"üë§ –ö–æ–º—É: {receiver_name}\n"
                f"üÜî ID —Å–æ–æ–±—â–µ–Ω–∏—è: #{message_id}\n\n"
                f"–°–æ–æ–±—â–µ–Ω–∏–µ:\n{message_text[:100]}...",
                parse_mode='Markdown',
                reply_markup=get_requests_main_keyboard()
            )
        else:
            await update.message.reply_text(
                "‚ùå –ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                reply_markup=get_requests_main_keyboard()
            )
    
    else:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∑–∞–≥–ª—É—à–∫–∞)
        await update.message.reply_text(
            f"‚úâÔ∏è *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é*\n\n"
            f"–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n{message_text}",
            parse_mode='Markdown',
            reply_markup=get_requests_main_keyboard()
        )
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.clear()
    
    from telegram.ext import ConversationHandler
    return ConversationHandler.END

async def start_review(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞"""
    query = update.callback_query
    await query.answer()
    
    request_id = int(query.data.replace("chat_review_", ""))
    context.user_data['review_request_id'] = request_id
    
    await query.edit_message_text(
        f"‚≠ê *–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É #{request_id}*\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É:",
        reply_markup=get_review_rating_keyboard()
    )
    return SELECT_RATING

async def process_rating(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞"""
    query = update.callback_query
    await query.answer()
    
    rating = int(query.data.replace("rate_", ""))
    context.user_data['review_rating'] = rating
    
    await query.edit_message_text(
        f"‚≠ê –û—Ü–µ–Ω–∫–∞: {'‚≠ê' * rating}\n\n"
        f"–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–∑—ã–≤—É:\n\n"
        f"*–°–æ–≤–µ—Ç:* –û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞, "
        f"—á—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å.",
        parse_mode='Markdown'
    )
    return SEND_REVIEW

async def save_review(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–∑—ã–≤"""
    comment = update.message.text
    request_id = context.user_data.get('review_request_id')
    rating = context.user_data.get('review_rating')
    user = update.effective_user
    
    if not request_id or not rating:
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞.",
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
    request = need_help_system.get_request_by_id(request_id)
    if not request:
        await update.message.reply_text(
            f"‚ùå –ó–∞–ø—Ä–æ—Å #{request_id} –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫)
    # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –∑–∞–∫–∞–∑—á–∏–∫—É
    reviewed_id = request['user_id']  # –ê–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤
    review_id = request_manager.save_review(
        request_id=request_id,
        reviewer_id=user.id,
        reviewed_id=reviewed_id,
        rating=rating,
        comment=comment
    )
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.clear()
    
    await update.message.reply_text(
        f"‚úÖ *–û—Ç–∑—ã–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!*\n\n"
        f"üÜî ID –æ—Ç–∑—ã–≤–∞: #{review_id}\n"
        f"‚≠ê –û—Ü–µ–Ω–∫–∞: {'‚≠ê' * rating}\n"
        f"üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment[:50]}...\n\n"
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –û–Ω –ø–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∞—Ç—å —Å–µ—Ä–≤–∏—Å.",
        parse_mode='Markdown',
        reply_markup=get_requests_main_keyboard()
    )
    
    from telegram.ext import ConversationHandler
    return ConversationHandler.END

async def show_my_reviews(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    reviews_data = request_manager.get_user_reviews(user_id)
    
    if reviews_data['count'] == 0:
        await update.message.reply_text(
            "‚≠ê *–ú–æ–∏ –æ—Ç–∑—ã–≤—ã*\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.\n"
            "–û—Ç–∑—ã–≤—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º.",
            parse_mode='Markdown',
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    await update.message.reply_text(
        f"‚≠ê *–ú–æ–∏ –æ—Ç–∑—ã–≤—ã*\n\n"
        f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
        f"‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: {reviews_data['count']}\n"
        f"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {reviews_data['average_rating']}/5\n\n"
        f"üëá –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∑—ã–≤—ã:",
        parse_mode='Markdown'
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –æ—Ç–∑—ã–≤–∞
    for review in reviews_data['reviews'][-3:]:
        review_text = (
            f"üìã *–ó–∞–ø—Ä–æ—Å #{review['request_id']}*\n"
            f"‚≠ê –û—Ü–µ–Ω–∫–∞: {'‚≠ê' * review['rating']}\n"
            f"üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\n{review['comment'][:150]}...\n"
            f"üìÖ {datetime.fromisoformat(review['timestamp']).strftime('%d.%m.%Y')}"
        )
        
        await update.message.reply_text(
            review_text,
            parse_mode='Markdown'
        )
    
    await update.message.reply_text(
        "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–≤–µ—Ä—Å–∏—é.",
        reply_markup=get_requests_main_keyboard()
    )

async def show_active_requests(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –∏–∑ need_help —Å–∏—Å—Ç–µ–º—ã
    requests = need_help_system.get_user_requests(user_id) # type: ignore
    
    if not requests:
        await update.message.reply_text(
            "üì≠ *–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã*\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.\n"
            "–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ —Ä–∞–∑–¥–µ–ª–µ 'üÜò –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å'.",
            parse_mode='Markdown',
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    active_requests = [
        req for req in requests 
        if req.get('is_active', False) and req.get('status') in ['open', 'in_progress']
    ]
    
    if not active_requests:
        await update.message.reply_text(
            "üì≠ *–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã*\n\n"
            "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.\n"
            "–í—Å–µ –≤–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã.",
            parse_mode='Markdown',
            reply_markup=get_requests_main_keyboard()
        )
        return
    
    await update.message.reply_text(
        f"üìã *–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ({len(active_requests)})*\n\n"
        f"üëá –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:",
        parse_mode='Markdown'
    )
    
    for request in active_requests[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
        time_ago = get_time_ago(request['created_at'])
        
        request_text = (
            f"üÜî *–ó–∞–ø—Ä–æ—Å #{request['id']}*\n"
            f"üìù {request.get('category', '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')}\n"
            f"üí∞ {request.get('budget', '–ë–µ–∑ –±—é–¥–∂–µ—Ç–∞')}\n"
            f"üìä –û—Ç–∫–ª–∏–∫–æ–≤: {request.get('applications_count', 0)}\n"
            f"üìÖ {time_ago}\n"
            f"üìã –°—Ç–∞—Ç—É—Å: {request.get('status', 'unknown')}"
        )
        
        keyboard = [[
            InlineKeyboardButton(
                "üí¨ –ß–∞—Ç", 
                callback_data=f"view_chat_{request['id']}"
            ),
            InlineKeyboardButton(
                "üìä –î–µ—Ç–∞–ª–∏", 
                callback_data=f"view_details_{request['id']}"
            ),
            InlineKeyboardButton(
                "üë• –û—Ç–∫–ª–∏–∫–∏", 
                callback_data=f"view_apps_{request['id']}"
            )
        ]]
        
        await update.message.reply_text(
            request_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    if len(active_requests) > 5:
        await update.message.reply_text(
            f"–ò –µ—â–µ {len(active_requests) - 5} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...",
            reply_markup=get_requests_main_keyboard()
        )

async def cancel_requests_flow(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å"""
    await update.message.reply_text(
        "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        reply_markup=get_requests_main_keyboard()
    )
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.clear()
    
    from telegram.ext import ConversationHandler
    return ConversationHandler.END

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
async def handle_requests_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—ë—Ä—Ç–∫–∞: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ª–ª–±–µ–∫–∏ –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ need_help"""
    if not _handle_request_callback:
        logger.error("handle_request_callback –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (need_help)")
        return
    try:
        await _handle_request_callback(update, context)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_requests_callback: {e}", exc_info=True)

async def search_requests(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫ –≤ need_help"""
    if not _search_requests:
        logger.error("search_requests –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (need_help)")
        return
    try:
        await _search_requests(update, context)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ search_requests wrapper: {e}", exc_info=True)

async def handle_request_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback'–æ–≤ –¥–ª—è –∑–∞—è–≤–æ–∫ (req_<id>_<action> –∏–ª–∏ <id>_<action>)"""
    query = update.callback_query
    if not query:
        return
    data = (query.data or "").strip()
    if not data:
        await query.answer()
        return

    parts = data.split("_")
    if len(parts) < 2:
        await query.answer("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback")
        return

    if parts[0] == "req":
        if len(parts) < 3:
            await query.answer("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback")
            return
        rid = parts[1]
        action = parts[2]
    else:
        rid = parts[0]
        action = parts[1] if len(parts) > 1 else "view"

    req = request_system.get_request_by_id(rid)
    if not req:
        await query.answer("–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    user = update.effective_user

    try:
        if action == "view":
            text = (
                f"üÜî –ó–∞—è–≤–∫–∞ #{req.get('id')}\n"
                f"üë§ –ê–≤—Ç–æ—Ä: {req.get('username','-')} ({req.get('user_id')})\n"
                f"üìå –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {req.get('category','-')}\n"
                f"üí¨ –û–ø–∏—Å–∞–Ω–∏–µ: {req.get('description','-')}\n"
                f"üí∞ –ë—é–¥–∂–µ—Ç: {req.get('budget','-')}\n"
                f"üìÖ –°—Ä–æ–∫: {req.get('deadline','-')}\n"
                f"üìá –ö–æ–Ω—Ç–∞–∫—Ç—ã: {req.get('contacts','-')}"
            )
            await query.message.reply_text(text)
            await query.answer()
            return

        elif action == "apply":
            target_user_id = req.get('user_id')
            if not target_user_id:
                await query.answer("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏")
                return
            try:
                send_text = (
                    f"ü§ù –û—Ç–∫–ª–∏–∫ –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É #{req.get('id')} –æ—Ç @{user.username or user.full_name}\n"
                    f"–°–≤—è–∂–∏—Ç–µ—Å—å: @{user.username}" if user.username else f"–°–≤—è–∂–∏—Ç–µ—Å—å: {user.full_name}"
                )
                await context.bot.send_message(chat_id=int(target_user_id), text=send_text)
                await query.answer("–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ—Ä—É –∑–∞—è–≤–∫–∏")
            except Exception:
                logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∫–ª–∏–∫–∞ –∞–≤—Ç–æ—Ä—É –∑–∞—è–≤–∫–∏")
                await query.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫ –∞–≤—Ç–æ—Ä—É")
            return

        elif action == "close":
            req['status'] = 'closed'
            req['closed_at'] = req.get('closed_at') or datetime.utcnow().isoformat()
            request_system._save()
            try:
                # —É–±—Ä–∞—Ç—å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
                if query.message:
                    await query.message.edit_reply_markup(reply_markup=None)
            except BadRequest:
                logger.debug("–ù–µ—Ç inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è / BadRequest")
            await query.answer("–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞")
            try:
                await query.message.reply_text(f"‚úÖ –ó–∞—è–≤–∫–∞ #{req.get('id')} –∑–∞–∫—Ä—ã—Ç–∞.")
            except Exception:
                pass
            return

    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback: %s", e)
        try:
            await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–µ–π—Å—Ç–≤–∏—è")
        except Exception:
            pass
        return